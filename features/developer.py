from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown
import asyncio

# Import the loading system
from utils.loading import show_loading, show_static_loading

class DeveloperHandler:
    def __init__(self):
        # Update these with your information
        self.developer = "@yourusername"  # Your Telegram username
        self.developer_github = "yourgithubusername"  # Your GitHub username
        self.developer_name = "Your Name"  # Your actual name
        self.developer_bio = "Full Stack Developer | Python Enthusiast | Open Source Contributor"
        self.version = "1.0.0"

        # Different animation types for different sections
        self.PROFILE_ANIMATION = "tech"  # Tech animation for developer profile
        self.SOURCE_ANIMATION = "rocket"  # Rocket animation for source code
        self.PROJECTS_ANIMATION = "stars"  # Stars animation for projects

    async def handle_developer_profile(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Show developer profile with loading animation"""
        query = update.callback_query
        await query.answer()

        # Show static loading first to preserve the window
        await show_static_loading(
            query.message,
            "üë®‚Äçüíª **Developer Profile**",
            "Loading profile",
            preserve_content=True,
            animation_type=self.PROFILE_ANIMATION,
        )

        # Start animated loading
        loading_task = await show_loading(
            query.message,
            "üë®‚Äçüíª **Developer Profile**",
            "Loading profile",
            animation_type=self.PROFILE_ANIMATION,
        )

        try:
            # Simulate some processing time
            await asyncio.sleep(0.6)

            # Build the profile content
            profile_text = self._build_developer_profile()
            keyboard = self._build_profile_keyboard()

            # Stop loading animation gracefully
            if loading_task and not loading_task.done():
                loading_task.cancel()
                try:
                    await loading_task
                except asyncio.CancelledError:
                    pass

            # Update with final content
            await query.edit_message_text(
                profile_text,
                parse_mode="MarkdownV2",
                reply_markup=InlineKeyboardMarkup(keyboard),
                disable_web_page_preview=True
            )

        except Exception as e:
            # Stop loading animation gracefully
            if loading_task and not loading_task.done():
                loading_task.cancel()
                try:
                    await loading_task
                except asyncio.CancelledError:
                    pass

            # Show error state
            await self._show_developer_error(query.message, "Profile Error")

    async def handle_source_code(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Show bot source code information with loading animation"""
        query = update.callback_query
        await query.answer()

        # Show static loading first to preserve the window
        await show_static_loading(
            query.message,
            "ü§ñ **Bot Source Code**",
            "Loading source info",
            preserve_content=True,
            animation_type=self.SOURCE_ANIMATION,
        )

        # Start animated loading
        loading_task = await show_loading(
            query.message,
            "ü§ñ **Bot Source Code**",
            "Loading source info",
            animation_type=self.SOURCE_ANIMATION,
        )

        try:
            # Simulate some processing time
            await asyncio.sleep(0.5)

            # Build the source content
            source_text = self._build_source_content()
            keyboard = self._build_source_keyboard()

            # Stop loading animation gracefully
            if loading_task and not loading_task.done():
                loading_task.cancel()
                try:
                    await loading_task
                except asyncio.CancelledError:
                    pass

            # Update with final content
            await query.edit_message_text(
                source_text,
                parse_mode="MarkdownV2",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        except Exception as e:
            # Stop loading animation gracefully
            if loading_task and not loading_task.done():
                loading_task.cancel()
                try:
                    await loading_task
                except asyncio.CancelledError:
                    pass

            # Show error state
            await self._show_developer_error(query.message, "Source Code Error")

    async def handle_other_projects(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Show other projects by the developer with loading animation"""
        query = update.callback_query
        await query.answer()

        # Show static loading first to preserve the window
        await show_static_loading(
            query.message,
            "üîÑ **Other Projects**",
            "Loading projects",
            preserve_content=True,
            animation_type=self.PROJECTS_ANIMATION,
        )

        # Start animated loading
        loading_task = await show_loading(
            query.message,
            "üîÑ **Other Projects**",
            "Loading projects",
            animation_type=self.PROJECTS_ANIMATION,
        )

        try:
            # Simulate some processing time
            await asyncio.sleep(0.7)

            # Build the projects content
            projects_text = self._build_projects_content()
            keyboard = self._build_projects_keyboard()

            # Stop loading animation gracefully
            if loading_task and not loading_task.done():
                loading_task.cancel()
                try:
                    await loading_task
                except asyncio.CancelledError:
                    pass

            # Update with final content
            await query.edit_message_text(
                projects_text,
                parse_mode="MarkdownV2",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        except Exception as e:
            # Stop loading animation gracefully
            if loading_task and not loading_task.done():
                loading_task.cancel()
                try:
                    await loading_task
                except asyncio.CancelledError:
                    pass

            # Show error state
            await self._show_developer_error(query.message, "Projects Error")

    def _build_developer_profile(self):
        """Build the developer profile content"""
        return (
            f"üë®‚Äçüíª *Developer Profile*\n\n"

            f"üè∑Ô∏è **Name:** {escape_markdown(self.developer_name, 2)}\n"
            f"üì± **Telegram:** {escape_markdown(self.developer, 2)}\n"
            f"üíª **GitHub:** [github\\.com/{self.developer_github}](https://github.com/{self.developer_github})\n\n"

            f"üìù *Bio:*\n{escape_markdown(self.developer_bio, 2)}\n\n"

            "üõ†Ô∏è *This Bot:*\n"
            f"‚Ä¢ Built with Python & python\\-telegram\\-bot\n"
            f"‚Ä¢ Uses GitHub REST API v3\n"
            f"‚Ä¢ Open source and free to use\n"
            f"‚Ä¢ Real\\-time data fetching\n\n"

            "üí° *Skills & Technologies:*\n"
            "üêç Python ‚Ä¢ ü§ñ Bot Development\n"
            "üåê Web Development ‚Ä¢ ‚ö° FastAPI\n"
            "üóÑÔ∏è Databases ‚Ä¢ ‚òÅÔ∏è Cloud Deployment\n"
            "üîß DevOps ‚Ä¢ üìä Data Analysis\n\n"

            "üìä *Bot Statistics:*\n"
            f"‚Ä¢ Version: `{escape_markdown(self.version, 2)}`\n"
            f"‚Ä¢ Language: Python 3\\.13\n"
            f"‚Ä¢ Framework: python\\-telegram\\-bot\n"
            f"‚Ä¢ API: GitHub REST API\n\n"

            "üí¨ *Contact:*\n"
            "‚Ä¢ Found a bug\\? Report it\\!\n"
            "‚Ä¢ Have suggestions\\? Let me know\\!\n"
            "‚Ä¢ Want to collaborate\\? Reach out\\!\n\n"

            "‚≠ê _If you like this bot, consider starring it on GitHub\\!_"
        )

    def _build_profile_keyboard(self):
        """Build the developer profile keyboard"""
        return [
            [
                InlineKeyboardButton("üêô GitHub Profile", url=f"https://github.com/{self.developer_github}"),
                InlineKeyboardButton("üìß Contact", url=f"https://t.me/{self.developer.replace('@', '')}")
            ],
            [
                InlineKeyboardButton("ü§ñ Bot Source Code", callback_data="source_code"),
                InlineKeyboardButton("‚≠ê Rate Bot", callback_data="rate_bot")
            ],
            [
                InlineKeyboardButton("üîÑ Other Projects", callback_data="other_projects")
            ],
            [
                InlineKeyboardButton("‚¨ÖÔ∏è Back to Start", callback_data="back_to_start")
            ]
        ]

    def _build_source_content(self):
        """Build the source code content"""
        return (
            "ü§ñ *Bot Source Code*\n\n"

            "üìÇ *Repository Structure:*\n"
            "```\n"
            "gitscope\\-bot/\n"
            "‚îú‚îÄ‚îÄ bot\\.py\n"
            "‚îú‚îÄ‚îÄ start/\n"
            "‚îÇ   ‚îú‚îÄ‚îÄ welcome\\.py\n"
            "‚îÇ   ‚îú‚îÄ‚îÄ help\\.py\n"
            "‚îÇ   ‚îú‚îÄ‚îÄ about\\.py\n"
            "‚îÇ   ‚îú‚îÄ‚îÄ developer\\.py\n"
            "‚îÇ   ‚îî‚îÄ‚îÄ router\\.py\n"
            "‚îú‚îÄ‚îÄ handlers/\n"
            "‚îú‚îÄ‚îÄ utils/\n"
            "‚îî‚îÄ‚îÄ requirements\\.txt\n"
            "```\n\n"

            "üõ†Ô∏è *Technologies Used:*\n"
            "‚Ä¢ **Language:** Python 3\\.13\n"
            "‚Ä¢ **Framework:** python\\-telegram\\-bot\n"
            "‚Ä¢ **HTTP Client:** aiohttp\n"
            "‚Ä¢ **API:** GitHub REST API v3\n"
            "‚Ä¢ **Deployment:** Cloud hosting\n\n"

            "üåü *Features:*\n"
            "‚Ä¢ Modular architecture\n"
            "‚Ä¢ Async/await for performance\n"
            "‚Ä¢ Error handling & timeouts\n"
            "‚Ä¢ Clean code structure\n"
            "‚Ä¢ Comprehensive logging\n\n"

            "üìù *Want to contribute\\?*\n"
            "‚Ä¢ Fork the repository\n"
            "‚Ä¢ Create a feature branch\n"
            "‚Ä¢ Submit a pull request\n"
            "‚Ä¢ Follow coding standards\n\n"

            "_This bot is open source and free to use\\!_"
        )

    def _build_source_keyboard(self):
        """Build the source code keyboard"""
        return [
            [
                InlineKeyboardButton("üìÇ View Source", url=f"https://github.com/{self.developer_github}/gitscope-bot"),
                InlineKeyboardButton("üêõ Report Bug", url=f"https://github.com/{self.developer_github}/gitscope-bot/issues")
            ],
            [
                InlineKeyboardButton("‚¨ÖÔ∏è Back to Profile", callback_data="developer_profile")
            ]
        ]

    def _build_projects_content(self):
        """Build the projects content"""
        return (
            "üîÑ *Other Projects*\n\n"

            "üöÄ *Recent Projects:*\n\n"

            "ü§ñ **AI Chat Bot**\n"
            "‚Ä¢ Multi\\-language support\n"
            "‚Ä¢ OpenAI integration\n"
            "‚Ä¢ Custom personality modes\n\n"

            "üåê **Portfolio Website**\n"
            "‚Ä¢ Modern responsive design\n"
            "‚Ä¢ Built with React & Node\\.js\n"
            "‚Ä¢ Deployed on Vercel\n\n"

            "üìä **Data Analysis Tools**\n"
            "‚Ä¢ Python automation scripts\n"
            "‚Ä¢ Data visualization\n"
            "‚Ä¢ Report generation\n\n"

            "üîß **DevOps Utilities**\n"
            "‚Ä¢ Docker configurations\n"
            "‚Ä¢ CI/CD pipelines\n"
            "‚Ä¢ Monitoring solutions\n\n"

            "üí° *Upcoming Projects:*\n"
            "‚Ä¢ GitHub Analytics Dashboard\n"
            "‚Ä¢ Code Review Assistant Bot\n"
            "‚Ä¢ Open Source Contribution Tracker\n\n"

            "‚≠ê _Check out my GitHub for more projects\\!_"
        )

    def _build_projects_keyboard(self):
        """Build the projects keyboard"""
        return [
            [
                InlineKeyboardButton("üêô All Projects", url=f"https://github.com/{self.developer_github}?tab=repositories"),
                InlineKeyboardButton("üåü Starred Repos", url=f"https://github.com/{self.developer_github}?tab=stars")
            ],
            [
                InlineKeyboardButton("‚¨ÖÔ∏è Back to Profile", callback_data="developer_profile")
            ]
        ]

    async def _show_developer_error(self, message, error_type):
        """Show error state for developer sections"""
        error_text = (
            f"üë®‚Äçüíª **Developer Section**\n\n"
            f"‚ùå **{error_type}**\n\n"
            f"Unable to load developer information.\n\n"
            f"üí° **Tip:** Try refreshing or go back to start!"
        )

        keyboard = [
            [
                InlineKeyboardButton("üîÑ Try Again", callback_data="developer_profile")
            ],
            [
                InlineKeyboardButton("‚¨ÖÔ∏è Back to Start", callback_data="back_to_start")
            ]
        ]

        try:
            await message.edit_text(
                error_text,
                parse_mode="Markdown",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
        except Exception:
            pass  # Silent fail for error display

    async def handle_rate_bot(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle bot rating"""
        query = update.callback_query
        await query.answer("‚≠ê Thanks for your interest! You can rate this bot by starring the GitHub repository!")

# Create instance
developer_handler = DeveloperHandler()
